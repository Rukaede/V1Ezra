local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "[Beta] Reborn Cultivation by itzRealEzra",
   Icon = 0, 
   LoadingTitle = "Rayfield Interface Suite",
   LoadingSubtitle = "by itzRealEzra",
   ShowText = "Rayfield", 
   Theme = "Default", 
   ToggleUIKeybind = "K", 
   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false, 
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Kaye Hub"
   },
   Discord = {
      Enabled = false, 
      Invite = "noinvitelink", 
      RememberJoins = true 
   },
   KeySystem = false, 
   KeySettings = {
      Title = "Untitled",
      Subtitle = "Key System",
      Note = "No method of obtaining the key is provided", 
      FileName = "Key",
      SaveKey = true, 
      GrabKeyFromSite = false, 
      Key = {"Hello"} 
   }
})

local MainTab = Window:CreateTab("Farming", nil)
local Tab = Window:CreateTab("Main")

Rayfield:Notify({
   Title = "You executed the script!",
   Content = "Very Good Gui",
   Duration = 5,
   Image = nil,
})

-- Services (ensure these exist above or keep here)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CraftPill = ReplicatedStorage:WaitForChild("Events"):WaitForChild("CraftPill")

-- State
local isCrafting = false
local selectedRarity = "100" -- default rarity
local totalToCraft = 0

-- Recipes (define your recipes here)
local recipes = {
    ["Awaked Qi Pill"] = {
        "Herb_Blood Flower",
        "Herb_Blood Flower",
        "Herb_Lotus",
        "Herb_Blood Flower",
        1
    },
    -- Add more recipes like:
    -- ["Lotus Pill"] = {"Herb_Lotus","Herb_Lotus","Herb_Blood Flower","Herb_Lotus",1},
}

-- Build dropdown options from recipes keys (ensures match)
local recipeOptions = {}
for k, _ in pairs(recipes) do
    table.insert(recipeOptions, k)
end
table.sort(recipeOptions)

if #recipeOptions == 0 then
    Rayfield:Notify({
        Title = "Auto Craft",
        Content = "No recipes defined in the script (recipes table is empty).",
        Duration = 5
    })
    return
end

local selectedRecipe = recipeOptions[1] -- safe default

-- Helper: build args for remote using chosen rarity (avoids double-appending if rarity already present)
local function buildArgsForRecipe(recipeTbl, rarity)
    local args = {}
    local count = #recipeTbl
    if count < 2 then
        return nil, "recipe table too short"
    end
    local perAmount = recipeTbl[count]
    for i = 1, count - 1 do
        local ing = recipeTbl[i]
        if type(ing) ~= "string" then
            return nil, "invalid ingredient (not string)"
        end
        if string.match(ing, "_%d+$") then
            table.insert(args, ing) -- already has rarity suffix
        else
            table.insert(args, ing .. "_" .. tostring(rarity))
        end
    end
    table.insert(args, perAmount)
    return args
end

-- UI: recipe dropdown (options built from recipes)
local DropDown = Tab:CreateDropdown({
    Name = "Select Pill Recipe",
    Options = recipeOptions,
    CurrentOption = selectedRecipe,
    Flag = "DropDown1",
    Callback = function(Option)
        -- Option will be one of the recipeOptions (because we built them)
        if recipes[Option] then
            selectedRecipe = Option
        else
            -- shouldn't happen, but handle gracefully
            Rayfield:Notify({
                Title = "Auto Craft",
                Content = "Selected recipe not found in recipes table.",
                Duration = 4
            })
        end
    end
})

-- UI: rarity dropdown
local RarityDrop = Tab:CreateDropdown({
    Name = "Select Rarity",
    Options = {"1", "10", "100", "1000", "10000", "100000"},
    CurrentOption = selectedRarity,
    Flag = "DropDown2",
    Callback = function(Option)
        selectedRarity = Option
    end
})

-- UI: input box for amount
local InputBox = Tab:CreateInput({
    Name = "Craft Amount",
    PlaceholderText = "Enter amount (e.g. 1000)",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        local num = tonumber(Text)
        if num and num > 0 then
            totalToCraft = math.floor(num)
        else
            totalToCraft = 0
        end
    end
})

-- UI: toggle to start/stop crafting
local Toggle = Tab:CreateToggle({
    Name = "Auto Craft",
    CurrentValue = false,
    Flag = "Toggle1",
    Callback = function(Value)
        isCrafting = Value

        if not Value then
            Rayfield:Notify({
                Title = "Auto Craft",
                Content = "Stopped by user",
                Duration = 3
            })
            return
        end

        -- validate before starting
        if totalToCraft <= 0 then
            Rayfield:Notify({
                Title = "Auto Craft",
                Content = "Enter a valid Craft Amount (>0) before starting.",
                Duration = 4
            })
            isCrafting = false
            return
        end

        local recipe = recipes[selectedRecipe]
        if not recipe then
            Rayfield:Notify({
                Title = "Auto Craft",
                Content = "Selected recipe doesn't exist. Check the recipes table.",
                Duration = 4
            })
            isCrafting = false
            return
        end

        Rayfield:Notify({
            Title = "Auto Craft",
            Content = ("Starting %s x%s (rarity %s)"):format(selectedRecipe, tostring(totalToCraft), tostring(selectedRarity)),
            Duration = 4
        })

        task.spawn(function()
            local finishedNormally = true
            for i = 1, totalToCraft do
                if not isCrafting then
                    finishedNormally = false
                    break
                end

                local args, err = buildArgsForRecipe(recipe, selectedRarity)
                if not args then
                    Rayfield:Notify({
                        Title = "Auto Craft",
                        Content = "Recipe build error: "..tostring(err),
                        Duration = 5
                    })
                    finishedNormally = false
                    break
                end

                local ok, fireErr = pcall(function()
                    CraftPill:FireServer(table.unpack(args))
                end)
                if not ok then
                    Rayfield:Notify({
                        Title = "Auto Craft",
                        Content = "Failed to fire CraftPill: "..tostring(fireErr),
                        Duration = 5
                    })
                    finishedNormally = false
                    break
                end

                task.wait(0.05)
            end

            if finishedNormally then
                Rayfield:Notify({
                    Title = "Auto Craft",
                    Content = ("Finished crafting %s x%s"):format(selectedRecipe, tostring(totalToCraft)),
                    Duration = 4
                })
            else
                Rayfield:Notify({
                    Title = "Auto Craft",
                    Content = "Crafting stopped early",
                    Duration = 3
                })
            end

            isCrafting = false
        end)
    end
})
